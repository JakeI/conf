#!/usr/bin/env bash

build_case() {
    file_name="${@: -1}"
    job_name="${file_name%.tex}"
    export max_print_line=1048576
    mkdir -p build
    latexmk \
        -pvc \
        -lualatex \
        -interaction=nonstopmode \
        -outdir=build/. \
        -auxdir=build/. \
        -cd- \
        -CF \
        -e '$pdf_previewer='"'$0 show'" \
        -e '$pdf_update_method=2' \
        -e '$lualatex="pplatex -q -c lualatex -- %O %S"' \
        "$@"
}

case "$1" in
  "clean" | "c" )
    shift # Remove the first argument
    if [ -d build/. ]; then
        case "$1" in
          all)
            latexmk -C -outdir=build/. -auxdir=build/.
            ;;
          *)
            latexmk -c -outdir=build/. -auxdir=build/.
        esac
    fi
    ;;
  "help" | "h")
    echo "runs latex in the build/. directory"
    echo "$0 [build|show|clean|help] [additional arguments]"
    echo "  build/b   : Run latexmk in continuous mode"
    echo "              last arg should be the file_name.tex"
    echo "  show/s    : display a pdf in a forked zathura instance"
    echo "  clean/c   : Perform clean operation."
    echo "  clean all : Clean everything including the pdf file"
    echo "  help/h    : Display this help message."
    shift # Remove the first argument
    ;;
  "show" | "s" )
    shift
    tmpdir=$(mktemp -d)
    cp $XDG_CONFIG_HOME/zathura/zathurarc $tmpdir/.
    echo 'set filemonitor "signal"' >> $tmpdir/zathurarc
    zathura --fork --config-dir=$tmpdir "$1"
    ;;
  "build" | "b" )
    shift
    build_case "$@"
    ;;
  *)
    # Check if arguments exist and the last argument is a .tex file
    if [ $# -gt 0 ] && [[ "${@: -1}" =~ \.tex$ ]] && [ -f "${@: -1}" ]; then
      build_case "$@"
    else
      echo "missing option run help for help"
    fi
    ;;
esac

